<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>La Famille ‚Äî Whisky & Cigar (Online)</title>
<link rel="icon" href="data:,"/>
<style>
:root{
  --bg:#0b0b0c; --fg:#f5f5f6; --muted:#a5a5ac;
  --panel:#141416; --line:#242428; --accent:#e08b2c; --bad:#ff5757; --good:#43c27d;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);}
h1,h2,h3{margin:8px 0 6px}
button{background:var(--accent);border:0;color:#111;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
input,select{background:#111114;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:10px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.badge{background:#222;padding:6px 10px;border-radius:999px;font-size:12px}
.small{font-size:12px;color:var(--muted)}

#landing{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:50}
#landing .wrap{width:min(680px,92%);}
#landing .row{margin:10px 0}
#lobby{display:none;position:sticky;top:0;z-index:40;border-bottom:1px solid var(--line)}
#lobby .wrap{display:flex;gap:10px;align-items:center;padding:10px}
#playerChips{display:flex;gap:6px;flex-wrap:wrap}
.chip{background:#1b1b1f;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
.chip .kick{margin-left:6px;color:var(--bad);cursor:pointer;font-weight:700;display:none}
.host .chip .kick{display:inline}

main{max-width:1100px;margin:70px auto 100px;padding:0 14px;display:none}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

.section{padding:12px}
.section h2{font-size:16px;margin-bottom:8px}
.list{display:grid;gap:6px}
.row-between{display:flex;justify-content:space-between;align-items:center}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:14px}

.log{max-height:320px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0f0f11}

.hidden{display:none !important}

html.lobby #landing{display:flex}
html.lobby #lobby{display:flex}
html.started #landing{display:none}
html.started main{display:block}

fieldset{border:1px solid var(--line);border-radius:10px;padding:10px;margin:0}
legend{padding:0 6px;color:var(--muted);font-size:12px}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SB_URL = "https://yogpjqdgpquomgtbcvxu.supabase.co";   // ‚Üê remplace par ton URL Supabase
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvZ3BqcWRncHF1b21ndGJjdnh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDc2MjgsImV4cCI6MjA3Njg4MzYyOH0.sK1DDyTPZZMAl4HbeigejK4cgydNFS68UjmB7JgbweA";   // ‚Üê remplace par ta anon public key

let supa = null;
const deviceId = localStorage.getItem("deviceId") || (crypto.randomUUID?.() || String(Math.random()).slice(2));
localStorage.setItem("deviceId", deviceId);

let roomId=null, roomCode=null, hostDeviceId=null, mePlayerId=null, isHost=false;
let chRoom=null, chPlayers=null, chLog=null, pollTimer=null;

function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}
function randCode(){const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let s="";for(let i=0;i<5;i++)s+=A[Math.floor(Math.random()*A.length)];return s}
function labelPhase(ph){return {secret:"Pr√©paration des magouilles", resolve:"R√©solution des magouilles", debate:"D√©bat", vote:"Vote"}[ph] || ph;}

document.addEventListener("DOMContentLoaded", async ()=>{
  if(!SB_URL||!SB_KEY){ alert("Configure SB_URL/SB_KEY en haut du fichier."); return; }
  supa = supabase.createClient(SB_URL, SB_KEY);
  document.documentElement.classList.add("lobby");
  $("#createBtn").onclick = createRoom;
  $("#joinBtn").onclick = joinRoom;
  $("#assignBtn").onclick = assignAndStart;
  $("#phaseSel").onchange = changePhase;
  $("#nextBtn").onclick = nextPhase;
  $("#resetBtn").onclick = resetLobby;
});

// ===== Create / Join =====
async function createRoom(){
  const pseudo = $("#pseudo").value.trim();
  let code = $("#code").value.trim();
  if(!pseudo) return alert("Entre un pseudo");
  if(!code) code = randCode();
  const { data: room, error } = await supa.from("game_rooms").insert({ code, host_device_id: deviceId, status:"lobby", phase:"secret", settings:{} }).select().single();
  if(error){
    if(String(error.message||"").includes("duplicate key")) return alert("Code d√©j√† pris. Essaie un autre.");
    return alert(error.message);
  }
  roomId=room.id; roomCode=room.code; hostDeviceId=room.host_device_id; isHost=true;
  await upsertPlayer(pseudo, true);
  enterLobby();
}

async function joinRoom(){
  const pseudo = $("#pseudo").value.trim();
  const code = $("#code").value.trim();
  if(!pseudo) return alert("Entre un pseudo");
  if(!code) return alert("Entre un code");
  const { data: room, error } = await supa.from("game_rooms").select("*").eq("code", code).maybeSingle();
  if(error || !room) return alert("Salle introuvable");
  roomId=room.id; roomCode=room.code; hostDeviceId=room.host_device_id; isHost=(hostDeviceId===deviceId);
  await upsertPlayer(pseudo, isHost);
  enterLobby();
}

async function upsertPlayer(name, asHost){
  const { data: existing } = await supa.from("game_players").select("id").eq("room_code", roomCode).eq("name", name).maybeSingle();
  if(existing){
    const { data: me } = await supa.from("game_players").update({ device_id: deviceId, is_host: asHost||false }).eq("id", existing.id).select().single();
    mePlayerId = me.id;
  }else{
    const { data: me } = await supa.from("game_players").insert({ room_id: roomId, room_code: roomCode, device_id: deviceId, name, is_host: asHost||false }).select().single();
    mePlayerId = me.id;
  }
  localStorage.setItem("roomCode", roomCode);
  localStorage.setItem("playerName", name);
}

// ===== Lobby =====
function enterLobby(){
  $("#landing").style.display="none";
  $("#lobby").style.display="block";
  $("main").style.display="none";
  $("#hostControls").style.display = isHost ? "block" : "none";
  $("#assignBtn").disabled = false;
  $("#phaseSel").disabled = !isHost;
  $("#nextBtn").disabled = !isHost;
  $("#resetBtn").disabled = !isHost;
  $("#lbCode").textContent = roomCode;
  subscribeRoom(); subscribePlayers(); subscribeLog();
  startPoll();
}

function startPoll(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(()=>{ refreshPlayers(); syncRoomPhase(); }, 1500);
}

function subscribeRoom(){
  if(chRoom) supa.removeChannel(chRoom);
  chRoom = supa.channel("room_"+roomId)
    .on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:"id=eq."+roomId}, payload=>{
      const r = payload.new || payload.old;
      if(r.status==="started") enterGame();
      if(r.phase) setPhaseUI(r.phase);
    })
    .subscribe();
  syncRoomPhase();
}

async function syncRoomPhase(){
  const { data: r } = await supa.from("game_rooms").select("status,phase,round").eq("id", roomId).single();
  if(!r) return;
  if(r.status==="started") enterGame();
  setPhaseUI(r.phase||"secret");
}

function subscribePlayers(){
  if(chPlayers) supa.removeChannel(chPlayers);
  chPlayers = supa.channel("players_"+roomId)
    .on("postgres_changes",{event:"*",schema:"public",table:"game_players",filter:"room_id=eq."+roomId}, payload=>{
      refreshPlayers(); refreshGroupTable();
    })
    .subscribe();
  refreshPlayers();
}

function subscribeLog(){
  if(chLog) supa.removeChannel(chLog);
  chLog = supa.channel("log_"+roomId)
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"game_log",filter:"room_id=eq."+roomId}, payload=> appendLog(payload.new))
    .subscribe();
  supa.from("game_log").select("*").eq("room_id", roomId).order("created_at",{ascending:true}).then(({data})=>{
    $("#logList").innerHTML="";
    (data||[]).forEach(appendLog);
  });
}

async function refreshPlayers(){
  const { data: players } = await supa.from("game_players").select("id,name,is_host,status").eq("room_id", roomId).order("created_at",{ascending:true});
  $("#lbCount").textContent = players?.length || 0;
  $("#playerChips").innerHTML = (players||[]).map(p=>`<span class="chip">${p.is_host?'üëë ':''}${p.name}${p.status==='DEAD'?' ‚ò†Ô∏è':''}${isHost?` <span class="kick" data-id="${p.id}" title="Retirer">‚úï</span>`:''}</span>`).join(" ");
}

document.addEventListener("click", async (e)=>{
  if(e.target.classList.contains("kick")){
    if(!isHost) return;
    const id = e.target.getAttribute("data-id");
    await supa.from("game_players").delete().eq("id", id);
    await supa.from("game_log").insert({ room_id: roomId, kind:"system", text:"üü• Un joueur a √©t√© retir√© du salon." });
    refreshPlayers();
  }
});

// ===== Assign & Start =====
function getLobbySettings(){
  return {
    init: {
      PARRAIN:   {glasses: parseInt($("#initParrainGl").value||"4",10), cigars: parseInt($("#initParrainCg").value||"1",10)},
      SOUS_CHEF: {glasses: parseInt($("#initSousGl").value||"4",10), cigars: parseInt($("#initSousCg").value||"1",10)},
      SOLDAT:    {glasses: parseInt($("#initSoldGl").value||"3",10), cigars: parseInt($("#initSoldCg").value||"0",10)},
      INFILTRE:  {glasses: parseInt($("#initInfGl").value||"3",10), cigars: parseInt($("#initInfCg").value||"0",10)}
    },
    counts: {
      soldiers: parseInt($("#optSoldiers").value||"0",10),
      infiltres: parseInt($("#optInfiltres").value||"0",10)
    }
  };
}

async function assignAndStart(){
  if(!isHost) return alert("Seul l‚Äôh√¥te");
  const { data: players } = await supa.from("game_players").select("id,name").eq("room_id", roomId).order("created_at",{ascending:true});
  if(!players || players.length<3) return alert("Il faut au moins 3 joueurs.");

  const set = getLobbySettings();
  const total = players.length;
  const fixed = 2;
  const remaining = total - fixed;
  if(set.counts.infiltres<0 || set.counts.soldiers<0 || set.counts.infiltres+set.counts.soldiers!==remaining){
    return alert("R√©partition invalide : Soldats + Infiltr√©s doit = joueurs restants.");
  }

  const shuffled = [...players].sort(()=>Math.random()-0.5);
  const assign = [];
  assign.push({id:shuffled[0].id, role:"PARRAIN"});
  assign.push({id:shuffled[1].id, role:"SOUS_CHEF"});
  let i=2;
  for(let k=0;k<set.counts.infiltres;k++) assign.push({id:shuffled[i++].id, role:"INFILTRE"});
  for(let k=0;k<set.counts.soldiers;k++)  assign.push({id:shuffled[i++].id, role:"SOLDAT"});

  for(const a of assign){
    const init = set.init[a.role] || {glasses:3, cigars:0};
    await supa.from("game_players").update({ role:a.role, glasses:init.glasses, cigars:init.cigars, status:"ALIVE" }).eq("id", a.id);
  }
  await supa.from("game_rooms").update({ status:"started", phase:"secret", round:1, settings:set }).eq("id", roomId);
  await supa.from("game_log").insert({ room_id: roomId, kind:"system", text:"üëë La famille est convoqu√©e. La partie commence." });
  enterGame();
}

// ===== Game =====
function enterGame(){
  document.documentElement.classList.remove("lobby");
  document.documentElement.classList.add("started");
  $("#lobby").style.display="block";
  $("main").style.display="block";
  refreshMe(); refreshGroupTable();
}

async function refreshMe(){
  const myName = localStorage.getItem("playerName");
  const { data: me } = await supa.from("game_players").select("*").eq("room_id", roomId).eq("name", myName).maybeSingle();
  if(!me){ $("#meCard").innerHTML = "<div class='small'>Rejoins avec ton pseudo pour r√©cup√©rer ta fiche.</div>"; return; }
  mePlayerId = me.id;
  const roleLabel = {PARRAIN:"Parrain", SOUS_CHEF:"Sous-chef", SOLDAT:"Soldat", INFILTRE:"Infiltr√©"}[me.role||""] || "‚Äî";
  $("#meCard").innerHTML = `
    <div class="row-between"><div><b>${myName}</b> ‚Äî <span class="badge">${roleLabel}</span></div><div class="small">Statut: ${me.status==='DEAD'?'‚ò†Ô∏è Mort':'üü¢ Vivant'}</div></div>
    <div class="row" style="margin-top:8px">
      <div class="badge">üç∑ <b>${me.glasses}</b></div>
      <div class="badge">üö¨ <b>${me.cigars}</b></div>
    </div>
  `;
}

async function refreshGroupTable(){
  const { data: players } = await supa.from("game_players").select("name,glasses,cigars,status").eq("room_id", roomId).order("created_at",{ascending:true});
  const rows = (players||[]).map(p=>`<tr><td>${p.name}</td><td>${p.status==='DEAD'?'‚ò†Ô∏è Mort':'üü¢ Vivant'}</td><td>${p.glasses} üç∑</td><td>${p.cigars} üö¨</td></tr>`).join("");
  $("#groupBody").innerHTML = rows;
}

// ===== Phases (host only) =====
function setPhaseUI(ph){ $("#phaseSel").value = ph || "secret"; }

async function changePhase(){
  if(!isHost) return alert("Seul l‚Äôh√¥te");
  const ph = $("#phaseSel").value;
  await supa.from("game_rooms").update({ phase: ph }).eq("id", roomId);
  await supa.from("game_log").insert({ room_id: roomId, kind:"system", text:`‚è≠Ô∏è Phase: ${labelPhase(ph)}` });
}

async function nextPhase(){
  if(!isHost) return alert("Seul l‚Äôh√¥te");
  const { data: r } = await supa.from("game_rooms").select("phase,round").eq("id", roomId).single();
  const order=["secret","resolve","debate","vote"];
  const i=Math.max(0, order.indexOf(r.phase||"secret"));
  const next=order[(i+1)%order.length];
  const round=(next==="secret")?(r.round+1):r.round;
  await supa.from("game_rooms").update({ phase: next, round }).eq("id", roomId);
  await supa.from("game_log").insert({ room_id: roomId, kind:"system", text:`‚è≠Ô∏è ${next==="secret"?"Nouveau tour "+round:"Phase: "+labelPhase(next)}` });
}

// ===== Reset =====
async function resetLobby(){
  if(!isHost) return alert("Seul l‚Äôh√¥te");
  await supa.from("game_rooms").update({ status:"lobby", phase:"secret", round:1 }).eq("id", roomId);
  await supa.from("game_log").insert({ room_id: roomId, kind:"system", text:"üîÅ Retour aux r√©glages." });
  location.reload();
}

// ===== Log =====
function appendLog(row){
  const el=document.createElement("div");
  el.className="small";
  el.textContent = new Date(row.created_at).toLocaleTimeString()+" ‚Äî "+row.text;
  const box=$("#logList");
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}
</script>
</head>
<body class="lobby">

<!-- Landing -->
<section id="landing">
  <div class="wrap card">
    <h1>La Famille ‚Äî Cr√©er ou Rejoindre</h1>
    <div class="row">
      <input id="pseudo" placeholder="Ton pseudo" maxlength="20" />
      <input id="code" placeholder="Code (ex: AB7Q9)" />
    </div>
    <div class="row">
      <button id="createBtn">Cr√©er une salle</button>
      <button id="joinBtn">Rejoindre</button>
    </div>
    <div class="small">Noms uniques par salle. Revenir avec le m√™me nom te reconnecte.</div>
  </div>
</section>

<!-- Lobby header -->
<header id="lobby" class="card">
  <div class="wrap">
    <span class="badge">Salle <b id="lbCode">‚Äî</b></span>
    <span class="badge">Joueurs <b id="lbCount">0</b></span>
    <div id="playerChips" class="row"></div>
    <span style="flex:1"></span>
    <div id="hostControls" class="row" style="display:none">
      <fieldset>
        <legend>Init par r√¥le</legend>
        <div class="row">
          <span>Parrain:</span>
          <select id="initParrainGl"><option>3</option><option selected>4</option><option>5</option></select>
          <span>üç∑</span>
          <select id="initParrainCg"><option selected>1</option><option>2</option><option>3</option></select>
          <span>üö¨</span>
        </div>
        <div class="row">
          <span>Sous-chef:</span>
          <select id="initSousGl"><option>3</option><option selected>4</option><option>5</option></select>
          <span>üç∑</span>
          <select id="initSousCg"><option selected>1</option><option>2</option><option>3</option></select>
          <span>üö¨</span>
        </div>
        <div class="row">
          <span>Soldat:</span>
          <select id="initSoldGl"><option selected>3</option><option>4</option><option>5</option></select>
          <span>üç∑</span>
          <select id="initSoldCg"><option selected>0</option><option>1</option><option>2</option></select>
          <span>üö¨</span>
        </div>
        <div class="row">
          <span>Infiltr√©:</span>
          <select id="initInfGl"><option selected>3</option><option>4</option><option>5</option></select>
          <span>üç∑</span>
          <select id="initInfCg"><option selected>0</option><option>1</option><option>2</option></select>
          <span>üö¨</span>
        </div>
      </fieldset>

      <fieldset>
        <legend>R√©partition</legend>
        <select id="optSoldiers">
          <option value="0">Soldats: 0</option>
          <option value="1">Soldats: 1</option>
          <option value="2">Soldats: 2</option>
          <option value="3">Soldats: 3</option>
          <option value="4">Soldats: 4</option>
          <option value="5">Soldats: 5</option>
          <option value="6">Soldats: 6</option>
          <option value="7">Soldats: 7</option>
          <option value="8">Soldats: 8</option>
          <option value="9">Soldats: 9</option>
        </select>
        <select id="optInfiltres">
          <option value="0">Infiltr√©s: 0</option>
          <option value="1">Infiltr√©s: 1</option>
          <option value="2">Infiltr√©s: 2</option>
          <option value="3">Infiltr√©s: 3</option>
          <option value="4">Infiltr√©s: 4</option>
          <option value="5">Infiltr√©s: 5</option>
          <option value="6">Infiltr√©s: 6</option>
        </select>
      </fieldset>

      <button id="assignBtn">Assigner & Convoquer</button>
      <select id="phaseSel" title="Phase (h√¥te)">
        <option value="secret">Pr√©paration des magouilles</option>
        <option value="resolve">R√©solution des magouilles</option>
        <option value="debate">D√©bat</option>
        <option value="vote">Vote</option>
      </select>
      <button id="nextBtn">Suivant</button>
      <button id="resetBtn" style="background:#444;color:#fff">Retour aux r√©glages</button>
    </div>
  </div>
</header>

<!-- Game -->
<main>
  <div class="grid">
    <section class="section card">
      <h2>Ta fiche</h2>
      <div id="meCard" class="list small">Chargement‚Ä¶</div>
    </section>

    <section class="section card">
      <h2>Tableau (groupe)</h2>
      <table class="table">
        <thead><tr><th>Joueur</th><th>Statut</th><th>Verres</th><th>Cigares</th></tr></thead>
        <tbody id="groupBody"></tbody>
      </table>
    </section>

    <section class="section card" style="grid-column:1/-1">
      <h2>Journal public</h2>
      <div id="logList" class="log small">‚Äî</div>
    </section>
  </div>
</main>

</body>
</html>
